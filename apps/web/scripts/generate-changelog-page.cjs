#!/usr/bin/env node

/**
 * Generate Changelog Page Component
 *
 * Parses CHANGELOG.md and generates a React component with embedded data.
 *
 * Run with: node scripts/generate-changelog-page.cjs
 */

const fs = require("fs");
const path = require("path");

const possiblePaths = [
  // From scripts/ directory - standard monorepo layout
  path.join(__dirname, "../../../CHANGELOG.md"),
  path.join(__dirname, "../../CHANGELOG.md"),
  // From cwd - could be apps/web or monorepo root depending on how turbo runs
  path.join(process.cwd(), "../../CHANGELOG.md"),
  path.join(process.cwd(), "../CHANGELOG.md"),
  path.join(process.cwd(), "CHANGELOG.md"),
  // Vercel paths - explicit /vercel/path0 structure
  "/vercel/path0/CHANGELOG.md",
];

const outputPath = path.join(__dirname, "../app/(main)/changelog/changelog-content.tsx");

function parseChangelog(content) {
  const versions = [];
  const lines = content.split("\n");

  let currentVersion = null;
  let currentSection = null;

  for (const line of lines) {
    const versionMatch = line.match(/^## \[([^\]]+)\] - (\d{4}-\d{2}-\d{2})/);
    if (versionMatch && versionMatch[1] && versionMatch[2]) {
      if (currentVersion) {
        if (currentSection) {
          currentVersion.sections.push(currentSection);
        }
        versions.push(currentVersion);
      }
      currentVersion = {
        version: versionMatch[1],
        date: versionMatch[2],
        sections: [],
      };
      currentSection = null;
      continue;
    }

    const sectionMatch = line.match(/^### (.+)/);
    if (sectionMatch && sectionMatch[1] && currentVersion) {
      if (currentSection) {
        currentVersion.sections.push(currentSection);
      }
      currentSection = {
        title: sectionMatch[1],
        items: [],
      };
      continue;
    }

    const itemMatch = line.match(/^- (.+)/);
    if (itemMatch && itemMatch[1] && currentSection) {
      currentSection.items.push(itemMatch[1]);
    }
  }

  if (currentVersion) {
    if (currentSection) {
      currentVersion.sections.push(currentSection);
    }
    versions.push(currentVersion);
  }

  return versions;
}

function main() {
  let content = null;
  let foundPath = null;

  for (const p of possiblePaths) {
    try {
      if (fs.existsSync(p)) {
        content = fs.readFileSync(p, "utf-8");
        foundPath = p;
        break;
      }
    } catch (e) {
      // Continue
    }
  }

  if (!content) {
    // CRITICAL: Don't overwrite the committed file - it has the correct content!
    // This preserves the generated file from git for Vercel deployments where
    // the monorepo CHANGELOG.md might not be accessible at build time.
    console.warn("⚠ CHANGELOG.md not found at any of these paths:");
    possiblePaths.forEach(p => console.warn(`   - ${p}`));
    console.warn("⚠ Keeping existing changelog-content.tsx (committed version)");
    return;
  }

  console.log(`✓ Found CHANGELOG.md at ${foundPath}`);

  const versions = parseChangelog(content);

  // Generate component with data as JSON
  const component = `// Auto-generated by scripts/generate-changelog-page.cjs
// DO NOT EDIT MANUALLY - Edit CHANGELOG.md instead
// Generated: ${new Date().toISOString()}

interface ChangelogVersion {
  version: string;
  date: string;
  sections: { title: string; items: string[] }[];
}

const versions: ChangelogVersion[] = ${JSON.stringify(versions, null, 2)};

function getSectionColor(title: string): string {
  const colors: Record<string, string> = {
    Added: "bg-green-500/10 dark:bg-green-500/10 text-green-700 dark:text-green-400 border-green-500/30 dark:border-green-500/20",
    Changed: "bg-blue-500/10 dark:bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-500/30 dark:border-blue-500/20",
    Fixed: "bg-yellow-500/10 dark:bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500/30 dark:border-yellow-500/20",
    Removed: "bg-red-500/10 dark:bg-red-500/10 text-red-700 dark:text-red-400 border-red-500/30 dark:border-red-500/20",
    Security: "bg-purple-500/10 dark:bg-purple-500/10 text-purple-700 dark:text-purple-400 border-purple-500/30 dark:border-purple-500/20",
    Deprecated: "bg-yellow-500/10 dark:bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500/30 dark:border-yellow-500/20",
  };
  return colors[title] || "bg-gray-500/10 dark:bg-gray-500/10 text-gray-700 dark:text-gray-400 border-gray-500/30 dark:border-gray-500/20";
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

export function ChangelogContent() {
  if (versions.length === 0) {
    return <p className="text-gray-600 dark:text-gray-400">No changelog entries found.</p>;
  }

  return (
    <div className="space-y-12">
      {versions.map((version) => (
        <article
          key={version.version}
          className="relative pl-8 border-l-2 border-gray-200 dark:border-gray-800"
        >
          <div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-gradient-to-r from-violet-500 to-blue-500" />
          <header className="mb-6">
            <div className="flex items-center gap-3 flex-wrap">
              <h2 className="text-2xl font-semibold text-gray-900 dark:text-white">
                v{version.version}
              </h2>
              <time
                dateTime={version.date}
                className="text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-0.5 rounded"
              >
                {formatDate(version.date)}
              </time>
            </div>
          </header>
          <div className="space-y-6">
            {version.sections.map((section, idx) => (
              <div key={idx}>
                <h3
                  className={\`inline-block text-sm font-medium px-2 py-1 rounded border mb-3 \${getSectionColor(section.title)}\`}
                >
                  {section.title}
                </h3>
                <ul className="space-y-2 text-gray-700 dark:text-gray-300">
                  {section.items.map((item, itemIdx) => (
                    <li
                      key={itemIdx}
                      className="flex items-start gap-2 text-sm leading-relaxed"
                    >
                      <span className="text-gray-400 dark:text-gray-500 mt-1.5">•</span>
                      <span>{item}</span>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </article>
      ))}
    </div>
  );
}
`;

  fs.writeFileSync(outputPath, component);
  console.log(`✓ Generated changelog-content.tsx (${versions.length} versions)`);
}

main();
