#!/usr/bin/env node

/**
 * Relationships Index Generator
 *
 * Fetches doc-resource relationships from the database
 * for inclusion in the RAG index. This enables the AI assistant
 * to recommend related resources when answering documentation questions.
 *
 * Run with: node scripts/generate-relationships-index.cjs
 */

const fs = require("fs");
const path = require("path");

// ===========================================================================
// CONFIGURATION
// ===========================================================================

const VERBOSE = true;
const MIN_CONFIDENCE = 0.6;

// ===========================================================================
// CONSOLE STYLING
// ===========================================================================

const colors = {
  reset: "\x1b[0m",
  green: "\x1b[32m",
  cyan: "\x1b[36m",
  yellow: "\x1b[33m",
  dim: "\x1b[2m",
};

function log(message, color = colors.reset) {
  if (VERBOSE) console.log(`${color}${message}${colors.reset}`);
}

// ===========================================================================
// RELATIONSHIPS DATA
// ===========================================================================

/**
 * Pre-computed relationships from database analysis
 * Generated by running initial-relationship-analysis inside Claude Code
 *
 * Structure: { docSlug: [{ resourceId, type, confidence, reasoning }] }
 */
const RELATIONSHIPS = {
  "api/index": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Core API documentation" },
    { resourceId: "anthropic-sdk-python", type: "recommended", confidence: 0.90, reasoning: "Official Python SDK" },
    { resourceId: "anthropic-sdk-typescript", type: "recommended", confidence: 0.90, reasoning: "Official TypeScript SDK" },
    { resourceId: "claude-dev", type: "related", confidence: 0.75, reasoning: "IDE integration using API" },
  ],
  "api/messages-api": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Core API reference" },
    { resourceId: "anthropic-sdk-python", type: "recommended", confidence: 0.90, reasoning: "Python SDK for messages API" },
    { resourceId: "anthropic-sdk-typescript", type: "recommended", confidence: 0.90, reasoning: "TypeScript SDK for messages API" },
  ],
  "api/models": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Model specifications" },
    { resourceId: "claude-model-spec", type: "related", confidence: 0.85, reasoning: "Model behavior specification" },
  ],
  "api/prompt-caching": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Caching documentation" },
    { resourceId: "anthropic-sdk-python", type: "recommended", confidence: 0.85, reasoning: "SDK caching support" },
  ],
  "api/streaming": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Streaming documentation" },
    { resourceId: "anthropic-sdk-python", type: "recommended", confidence: 0.90, reasoning: "Python streaming support" },
    { resourceId: "anthropic-sdk-typescript", type: "recommended", confidence: 0.90, reasoning: "TypeScript streaming support" },
  ],
  "api/tool-use": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Tool use documentation" },
    { resourceId: "mcp-specification", type: "related", confidence: 0.85, reasoning: "MCP extends tool use" },
    { resourceId: "anthropic-cookbook", type: "example", confidence: 0.80, reasoning: "Tool use examples" },
  ],
  "api/vision": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.95, reasoning: "Vision API documentation" },
    { resourceId: "anthropic-cookbook", type: "example", confidence: 0.80, reasoning: "Vision examples" },
  ],
  "configuration/allowed-tools": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "CLI tool configuration" },
    { resourceId: "claude-code-prompts", type: "related", confidence: 0.75, reasoning: "System prompt examples" },
  ],
  "configuration/environment-variables": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "CLI environment config" },
    { resourceId: "clauderc-manager", type: "related", confidence: 0.70, reasoning: "Config management tool" },
  ],
  "configuration/global-config": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Global config reference" },
    { resourceId: "clauderc-manager", type: "related", confidence: 0.75, reasoning: "Config management" },
  ],
  "configuration/model-settings": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Model configuration" },
    { resourceId: "anthropic-docs", type: "related", confidence: 0.80, reasoning: "Model capabilities" },
  ],
  "configuration/project-config": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Project config documentation" },
    { resourceId: "awesome-claude-rules", type: "related", confidence: 0.80, reasoning: "CLAUDE.md examples" },
    { resourceId: "anthropic-claude-code-base-rules", type: "recommended", confidence: 0.85, reasoning: "Official base rules" },
  ],
  "examples/real-world-projects": [
    { resourceId: "anthropic-cookbook", type: "example", confidence: 0.90, reasoning: "Code examples" },
    { resourceId: "awesome-claude", type: "related", confidence: 0.85, reasoning: "Community projects" },
  ],
  "getting-started/basic-usage": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Getting started guide" },
    { resourceId: "claude-code-prompts", type: "related", confidence: 0.75, reasoning: "Usage examples" },
  ],
  "getting-started/installation": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Installation guide" },
    { resourceId: "anthropic-console", type: "required", confidence: 0.90, reasoning: "API key creation" },
  ],
  "getting-started/quickstart": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Quickstart guide" },
    { resourceId: "anthropic-console", type: "required", confidence: 0.90, reasoning: "Account setup" },
  ],
  "getting-started/what-is-claude-code": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Official documentation" },
    { resourceId: "anthropic-news", type: "related", confidence: 0.70, reasoning: "Product announcements" },
  ],
  "integrations/cursor": [
    { resourceId: "cursor-directory", type: "required", confidence: 0.90, reasoning: "Cursor rules directory" },
    { resourceId: "claude-dev", type: "related", confidence: 0.75, reasoning: "Alternative IDE extension" },
  ],
  "integrations/github": [
    { resourceId: "github-mcp-server", type: "required", confidence: 0.95, reasoning: "GitHub MCP server" },
    { resourceId: "claude-code-action", type: "recommended", confidence: 0.90, reasoning: "GitHub Actions integration" },
  ],
  "integrations/ide-extensions": [
    { resourceId: "claude-dev", type: "required", confidence: 0.95, reasoning: "VS Code extension" },
    { resourceId: "continue", type: "alternative", confidence: 0.85, reasoning: "Alternative IDE extension" },
    { resourceId: "avante-nvim", type: "alternative", confidence: 0.80, reasoning: "Neovim integration" },
    { resourceId: "aider", type: "alternative", confidence: 0.80, reasoning: "Terminal-based coding" },
  ],
  "integrations/mcp-servers": [
    { resourceId: "mcp-specification", type: "required", confidence: 0.95, reasoning: "MCP protocol spec" },
    { resourceId: "mcp-servers-hub", type: "required", confidence: 0.95, reasoning: "Server registry" },
    { resourceId: "filesystem-mcp-server", type: "example", confidence: 0.85, reasoning: "Example MCP server" },
    { resourceId: "github-mcp-server", type: "example", confidence: 0.85, reasoning: "GitHub MCP server" },
    { resourceId: "postgres-mcp-server", type: "example", confidence: 0.85, reasoning: "Postgres MCP server" },
    { resourceId: "memory-mcp-server", type: "example", confidence: 0.85, reasoning: "Memory MCP server" },
    { resourceId: "puppeteer-mcp-server", type: "example", confidence: 0.85, reasoning: "Browser automation MCP" },
    { resourceId: "brave-search-mcp-server", type: "example", confidence: 0.85, reasoning: "Search MCP server" },
    { resourceId: "sequential-thinking-mcp", type: "example", confidence: 0.80, reasoning: "Reasoning MCP server" },
    { resourceId: "fastmcp", type: "related", confidence: 0.80, reasoning: "MCP server framework" },
    { resourceId: "mcp-typescript-sdk", type: "related", confidence: 0.80, reasoning: "TypeScript SDK for MCP" },
  ],
  "integrations/slack": [
    { resourceId: "slack-mcp-server", type: "required", confidence: 0.95, reasoning: "Slack MCP server" },
    { resourceId: "mcp-servers-hub", type: "related", confidence: 0.75, reasoning: "MCP server registry" },
  ],
  "integrations/third-party": [
    { resourceId: "mcp-servers-hub", type: "required", confidence: 0.90, reasoning: "Third-party integrations" },
    { resourceId: "langchain-anthropic", type: "related", confidence: 0.80, reasoning: "LangChain integration" },
  ],
  "integrations/windsurf": [
    { resourceId: "cursor-directory", type: "related", confidence: 0.75, reasoning: "Rules format similar" },
  ],
  "tips-and-tricks/advanced-prompting": [
    { resourceId: "anthropic-prompt-library", type: "required", confidence: 0.95, reasoning: "Prompt examples" },
    { resourceId: "claude-code-prompts", type: "recommended", confidence: 0.90, reasoning: "System prompts" },
    { resourceId: "anthropic-cookbook", type: "related", confidence: 0.85, reasoning: "Prompting patterns" },
    { resourceId: "fabric", type: "related", confidence: 0.75, reasoning: "Prompt patterns framework" },
  ],
  "tips-and-tricks/agentic-patterns": [
    { resourceId: "claude-agent-sdk", type: "required", confidence: 0.95, reasoning: "Agent SDK reference" },
    { resourceId: "computer-use-demo", type: "example", confidence: 0.85, reasoning: "Agent example" },
    { resourceId: "openai-swarm", type: "related", confidence: 0.80, reasoning: "Agent framework" },
    { resourceId: "pydantic-ai", type: "related", confidence: 0.80, reasoning: "Typed agent framework" },
    { resourceId: "magentic-one", type: "related", confidence: 0.75, reasoning: "Multi-agent system" },
    { resourceId: "autogen", type: "related", confidence: 0.75, reasoning: "Agent framework" },
  ],
  "tips-and-tricks/best-practices": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Official best practices" },
    { resourceId: "awesome-claude-rules", type: "recommended", confidence: 0.90, reasoning: "Community best practices" },
    { resourceId: "anthropic-claude-code-base-rules", type: "recommended", confidence: 0.90, reasoning: "Base rule templates" },
    { resourceId: "anthropic-courses", type: "related", confidence: 0.80, reasoning: "Learning resources" },
  ],
  "tips-and-tricks/common-mistakes": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.90, reasoning: "Documentation reference" },
    { resourceId: "anthropic-cookbook", type: "related", confidence: 0.75, reasoning: "Common patterns" },
  ],
  "tips-and-tricks/performance": [
    { resourceId: "anthropic-docs", type: "required", confidence: 0.90, reasoning: "API performance" },
    { resourceId: "claude-code-docs", type: "required", confidence: 0.90, reasoning: "CLI performance" },
    { resourceId: "litellm", type: "related", confidence: 0.75, reasoning: "API proxy/caching" },
  ],
  "tutorials/build-cli-tool": [
    { resourceId: "anthropic-sdk-python", type: "required", confidence: 0.90, reasoning: "Python SDK for CLI" },
    { resourceId: "anthropic-sdk-typescript", type: "required", confidence: 0.90, reasoning: "TypeScript SDK for CLI" },
    { resourceId: "anthropic-cookbook", type: "example", confidence: 0.85, reasoning: "Code examples" },
  ],
  "tutorials/create-mcp-server": [
    { resourceId: "mcp-specification", type: "required", confidence: 0.95, reasoning: "MCP protocol spec" },
    { resourceId: "mcp-typescript-sdk", type: "required", confidence: 0.95, reasoning: "TypeScript MCP SDK" },
    { resourceId: "fastmcp", type: "recommended", confidence: 0.90, reasoning: "Python MCP framework" },
    { resourceId: "mcp-servers-hub", type: "related", confidence: 0.85, reasoning: "Server examples" },
  ],
  "tutorials/project-setup": [
    { resourceId: "claude-code-docs", type: "required", confidence: 0.95, reasoning: "Project setup guide" },
    { resourceId: "awesome-claude-rules", type: "recommended", confidence: 0.85, reasoning: "CLAUDE.md examples" },
    { resourceId: "anthropic-claude-code-base-rules", type: "recommended", confidence: 0.90, reasoning: "Base rules template" },
  ],
  "tutorials/web-app": [
    { resourceId: "anthropic-sdk-typescript", type: "required", confidence: 0.95, reasoning: "TypeScript SDK for web" },
    { resourceId: "anthropic-cookbook", type: "example", confidence: 0.85, reasoning: "Web app examples" },
    { resourceId: "vercel-ai-sdk", type: "recommended", confidence: 0.85, reasoning: "React/Next.js integration" },
  ],
};

/**
 * Reverse index: resource -> docs that reference it
 */
function buildReverseIndex(relationships) {
  const reverseIndex = {};

  for (const [docSlug, rels] of Object.entries(relationships)) {
    for (const rel of rels) {
      if (!reverseIndex[rel.resourceId]) {
        reverseIndex[rel.resourceId] = [];
      }
      reverseIndex[rel.resourceId].push({
        docSlug,
        type: rel.type,
        confidence: rel.confidence,
        reasoning: rel.reasoning,
      });
    }
  }

  return reverseIndex;
}

/**
 * Generate relationship chunks for the RAG index
 */
function generateRelationshipChunks() {
  const chunks = [];
  const reverseIndex = buildReverseIndex(RELATIONSHIPS);

  // Create chunks that help the AI recommend resources
  for (const [resourceId, docRefs] of Object.entries(reverseIndex)) {
    const sortedRefs = docRefs.sort((a, b) => b.confidence - a.confidence);
    const topRefs = sortedRefs.slice(0, 5);

    const content = [
      `Resource "${resourceId}" is related to the following documentation:`,
      ...topRefs.map(ref =>
        `- ${ref.docSlug}: ${ref.reasoning} (${ref.type}, ${Math.round(ref.confidence * 100)}% confidence)`
      ),
    ].join("\n");

    chunks.push({
      id: `relationship-${resourceId}`,
      title: `Resource Relationships: ${resourceId}`,
      section: "Related Documentation",
      content,
      url: `/resources?highlight=${resourceId}`,
      category: "Relationships",
      keywords: [resourceId, ...topRefs.map(r => r.docSlug.replace(/\//g, " "))].flat(),
      isRelationship: true,
      relatedDocs: topRefs.map(r => r.docSlug),
    });
  }

  log(`  Generated ${chunks.length} relationship chunks`, colors.green);

  return chunks;
}

/**
 * Get relationships data for resource enhancement
 * Returns a map of resourceId -> { relatedDocs, totalConfidence }
 */
function getResourceRelationships() {
  const reverseIndex = buildReverseIndex(RELATIONSHIPS);
  const resourceRelationships = {};

  for (const [resourceId, docRefs] of Object.entries(reverseIndex)) {
    const sortedRefs = docRefs.sort((a, b) => b.confidence - a.confidence);
    resourceRelationships[resourceId] = {
      relatedDocs: sortedRefs.map(r => ({
        slug: r.docSlug,
        type: r.type,
        confidence: r.confidence,
      })),
      avgConfidence: sortedRefs.reduce((sum, r) => sum + r.confidence, 0) / sortedRefs.length,
      docCount: sortedRefs.length,
    };
  }

  return resourceRelationships;
}

/**
 * Get doc-to-resource relationships for doc chunk enhancement
 * Returns a map of docSlug -> [{ resourceId, type, confidence }]
 */
function getDocRelationships() {
  return RELATIONSHIPS;
}

// Export for use in generate-rag-index.cjs
module.exports = {
  generateRelationshipChunks,
  getResourceRelationships,
  getDocRelationships,
  RELATIONSHIPS,
};

// CLI execution
if (require.main === module) {
  log("\n╔══════════════════════════════════════════════════╗", colors.cyan);
  log("║     RELATIONSHIPS INDEX GENERATOR                ║", colors.cyan);
  log("╚══════════════════════════════════════════════════╝\n", colors.cyan);

  const chunks = generateRelationshipChunks();
  const resourceRels = getResourceRelationships();
  const docRels = getDocRelationships();

  log("\n  Statistics:", colors.yellow);
  log(`    Relationship chunks: ${chunks.length}`, colors.dim);
  log(`    Resources with relationships: ${Object.keys(resourceRels).length}`, colors.dim);
  log(`    Docs with relationships: ${Object.keys(docRels).length}`, colors.dim);

  // Show sample
  log("\n  Sample relationship chunk:", colors.yellow);
  if (chunks[0]) {
    console.log(JSON.stringify(chunks[0], null, 2));
  }

  log("\n  Done!\n", colors.green);
}
