#!/usr/bin/env node

/**
 * Generate Changelog Data
 *
 * Parses CHANGELOG.md from monorepo root and generates a TypeScript
 * data file that can be imported by the changelog page.
 *
 * Run with: node scripts/generate-changelog.cjs
 */

const fs = require("fs");
const path = require("path");

// Try multiple possible locations for CHANGELOG.md
const possiblePaths = [
  path.join(__dirname, "../../../CHANGELOG.md"),  // From monorepo root
  path.join(__dirname, "../../CHANGELOG.md"),     // If run from apps/
  path.join(process.cwd(), "../../CHANGELOG.md"), // Relative to cwd
  path.join(process.cwd(), "CHANGELOG.md"),       // In current dir
];

const outputPath = path.join(__dirname, "../data/changelog-data.ts");

function parseChangelog(content) {
  const versions = [];
  const lines = content.split("\n");

  let currentVersion = null;
  let currentSection = null;

  for (const line of lines) {
    // Match version headers: ## [x.x.x] - YYYY-MM-DD
    const versionMatch = line.match(/^## \[([^\]]+)\] - (\d{4}-\d{2}-\d{2})/);
    if (versionMatch && versionMatch[1] && versionMatch[2]) {
      if (currentVersion) {
        if (currentSection) {
          currentVersion.sections.push(currentSection);
        }
        versions.push(currentVersion);
      }
      currentVersion = {
        version: versionMatch[1],
        date: versionMatch[2],
        sections: [],
      };
      currentSection = null;
      continue;
    }

    // Match section headers: ### Added, ### Changed, etc.
    const sectionMatch = line.match(/^### (.+)/);
    if (sectionMatch && sectionMatch[1] && currentVersion) {
      if (currentSection) {
        currentVersion.sections.push(currentSection);
      }
      currentSection = {
        title: sectionMatch[1],
        items: [],
      };
      continue;
    }

    // Match list items: - item
    const itemMatch = line.match(/^- (.+)/);
    if (itemMatch && itemMatch[1] && currentSection) {
      currentSection.items.push(itemMatch[1]);
    }
  }

  // Push the last version and section
  if (currentVersion) {
    if (currentSection) {
      currentVersion.sections.push(currentSection);
    }
    versions.push(currentVersion);
  }

  return versions;
}

function main() {
  let content = null;
  let foundPath = null;

  // Find CHANGELOG.md
  for (const p of possiblePaths) {
    try {
      if (fs.existsSync(p)) {
        content = fs.readFileSync(p, "utf-8");
        foundPath = p;
        break;
      }
    } catch (e) {
      // Continue to next path
    }
  }

  if (!content) {
    console.warn("⚠ CHANGELOG.md not found, generating empty changelog");
    const emptyOutput = `// Auto-generated by scripts/generate-changelog.cjs
// DO NOT EDIT MANUALLY

export interface ChangelogVersion {
  version: string;
  date: string;
  sections: { title: string; items: string[] }[];
}

export const changelogVersions: ChangelogVersion[] = [];
`;
    fs.writeFileSync(outputPath, emptyOutput);
    return;
  }

  console.log(`✓ Found CHANGELOG.md at ${foundPath}`);

  const versions = parseChangelog(content);

  // Generate TypeScript file
  const tsContent = `// Auto-generated by scripts/generate-changelog.cjs
// DO NOT EDIT MANUALLY - Edit CHANGELOG.md instead
// Generated: ${new Date().toISOString()}

export interface ChangelogVersion {
  version: string;
  date: string;
  sections: { title: string; items: string[] }[];
}

export const changelogVersions: ChangelogVersion[] = ${JSON.stringify(versions, null, 2)};
`;

  fs.writeFileSync(outputPath, tsContent);
  console.log(`✓ Generated changelog-data.ts (${versions.length} versions)`);
}

main();
